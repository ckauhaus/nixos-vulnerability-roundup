#!/usr/bin/env python3
"""Takes JSON output and creates a vulnerability roundup issue.

Feed the output of `vulnix --json` into this script to create the issue
description.
"""

import urllib.parse
import argparse
import json
import sys


def parse(json_file):
    if json_file:
        return json.load(json_file)
    return json.load(sys.stdin)


def fmt_cve(pkgs, f=sys.stdout):
    for pkg in sorted(pkgs, key=lambda p: p['name']):
        name = pkg['name']
        quotedname = urllib.parse.quote_plus(pkg['pname'])
        search = 'https://search.nix.gsc.io/?q={}&i=fosho&repos=nixos-nixpkgs'.\
            format(quotedname)
        files = 'https://github.com/NixOS/nixpkgs/search?utf8=%E2%9C%93&q={}+in%3Apath&type=Code'.\
            format(quotedname)
        print("### {name} ([search]({search}), [files]({files}))".\
              format(name=name, search=search, files=files), file=f)
        cves = ("[{}]({})".format(
            cve, 'https://nvd.nist.gov/vuln/detail/' + cve)
            for cve in sorted(pkg['affected_by']))
        for cve in cves:
            print(' - [ ] {}'.format(cve), file=f)
        print(file=f)


def output(git_id, pkgs, f=sys.stdout):
    print('Scanned nixos/release-combined.nix @ {id}. Filtered out '
          'previously reported CVEs. May contain false positives.\n'.
          format(id=git_id[:7]), file=f)
    fmt_cve(pkgs, f)
    print("""\
Cc: @joepie91, @phanimahesh, @the-kenny, @7c6f434c, @k0001, @peterhoeg, @nh2, @LnL7, @grahamc, @adisbladis, @fpletz, @vcunat, @andir, @sphalerite

Contact @ckauhaus for any questions.
""", file=f)


def main():
    a = argparse.ArgumentParser(description=__doc__)
    a.add_argument('VULNIX_JSON', nargs='?', type=argparse.FileType('r'),
                   help='vulnix json output (file or "-")')
    a.add_argument('-g', '--git-id', default='HEAD',
                   help='nixpkgs commit used for scanning')
    args = a.parse_args()
    output(parse(args.VULNIX_JSON))


if __name__ == '__main__':
    main()
