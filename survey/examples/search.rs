use futures::stream::Stream;
use hubcaps::search::IssuesItem;
use tokio;

const ISSUE_70129: &str = r#"
{
  "url": "https://api.github.com/repos/NixOS/nixpkgs/issues/70129",
  "repository_url": "https://api.github.com/repos/NixOS/nixpkgs",
  "labels_url": "https://api.github.com/repos/NixOS/nixpkgs/issues/70129/labels{/name}",
  "comments_url": "https://api.github.com/repos/NixOS/nixpkgs/issues/70129/comments",
  "events_url": "https://api.github.com/repos/NixOS/nixpkgs/issues/70129/events",
  "html_url": "https://github.com/NixOS/nixpkgs/issues/70129",
  "id": 500497813,
  "node_id": "MDU6SXNzdWU1MDA0OTc4MTM=",
  "number": 70129,
  "title": "Vulnerability roundup 76: unzip-6.0: 1 advisory",
  "user": {
    "login": "ckauhaus",
    "id": 1448923,
    "node_id": "MDQ6VXNlcjE0NDg5MjM=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/1448923?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ckauhaus",
    "html_url": "https://github.com/ckauhaus",
    "followers_url": "https://api.github.com/users/ckauhaus/followers",
    "following_url": "https://api.github.com/users/ckauhaus/following{/other_user}",
    "gists_url": "https://api.github.com/users/ckauhaus/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ckauhaus/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ckauhaus/subscriptions",
    "organizations_url": "https://api.github.com/users/ckauhaus/orgs",
    "repos_url": "https://api.github.com/users/ckauhaus/repos",
    "events_url": "https://api.github.com/users/ckauhaus/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ckauhaus/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 126506420,
      "node_id": "MDU6TGFiZWwxMjY1MDY0MjA=",
      "url": "https://api.github.com/repos/NixOS/nixpkgs/labels/1.severity:%20security",
      "name": "1.severity: security",
      "color": "e11d21",
      "default": false
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-09-30T20:10:40Z",
  "updated_at": "2019-10-02T09:14:56Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "body": "[search](https://search.nix.gsc.io/?q=unzip&i=fosho&repos=nixos-nixpkgs), [files](https://github.com/NixOS/nixpkgs/search?utf8=%E2%9C%93&q=unzip+in%3Apath&type=Code)\n\n* [ ] [CVE-2019-13232](https://nvd.nist.gov/vuln/detail/CVE-2019-13232) (nixos-19.09)\n\nScanned versions: nixos-19.09: e34ac949d1b. May contain false positives.",
  "closed_by": null
}
"#;

const ISSUE_64663: &str = r#"
{
  "url": "https://api.github.com/repos/NixOS/nixpkgs/issues/64663",
  "repository_url": "https://api.github.com/repos/NixOS/nixpkgs",
  "labels_url": "https://api.github.com/repos/NixOS/nixpkgs/issues/64663/labels{/name}",
  "comments_url": "https://api.github.com/repos/NixOS/nixpkgs/issues/64663/comments",
  "events_url": "https://api.github.com/repos/NixOS/nixpkgs/issues/64663/events",
  "html_url": "https://github.com/NixOS/nixpkgs/issues/64663",
  "id": 467331412,
  "node_id": "MDU6SXNzdWU0NjczMzE0MTI=",
  "number": 64663,
  "title": "Vulnerability roundup 72: unzip-6.0: 1 advisory",
  "user": {
    "login": "ckauhaus",
    "id": 1448923,
    "node_id": "MDQ6VXNlcjE0NDg5MjM=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/1448923?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ckauhaus",
    "html_url": "https://github.com/ckauhaus",
    "followers_url": "https://api.github.com/users/ckauhaus/followers",
    "following_url": "https://api.github.com/users/ckauhaus/following{/other_user}",
    "gists_url": "https://api.github.com/users/ckauhaus/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ckauhaus/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ckauhaus/subscriptions",
    "organizations_url": "https://api.github.com/users/ckauhaus/orgs",
    "repos_url": "https://api.github.com/users/ckauhaus/repos",
    "events_url": "https://api.github.com/users/ckauhaus/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ckauhaus/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 126506420,
      "node_id": "MDU6TGFiZWwxMjY1MDY0MjA=",
      "url": "https://api.github.com/repos/NixOS/nixpkgs/labels/1.severity:%20security",
      "name": "1.severity: security",
      "color": "e11d21",
      "default": false
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-07-12T10:05:01Z",
  "updated_at": "2019-07-23T15:25:15Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "body": "[search](https://search.nix.gsc.io/?q=unzip&i=fosho&repos=nixos-nixpkgs), [files](https://github.com/NixOS/nixpkgs/search?utf8=%E2%9C%93&q=unzip+in%3Apath&type=Code)\r\n\r\n* [ ] [CVE-2019-13232](https://nvd.nist.gov/vuln/detail/CVE-2019-13232) (nixos-unstable, nixos-19.03)\r\n\r\nScanned versions: nixos-unstable: beff2f8d75e; nixos-19.03: ecc64b374b2. May contain false positives.\r\n",
  "closed_by": null
}
"#;

/*
use hubcaps::Github;
use hubcaps::search::{SearchIssuesOptions, SearchResult};
use serde_json::json;

const Q: &str = "repo:NixOS/nixpkgs is:open in:title \"Vulnerability roundup\" unzip-6.0";

fn query() -> hubcaps::Stream<IssuesItem> {
    let github = Github::new("vulnerability roundup", None);
    github.search().issues().iter(Q, &SearchIssuesOptions::builder().build())
}
*/

fn query() -> hubcaps::Stream<IssuesItem> {
    Box::new(futures::stream::iter_ok(vec![
        serde_json::from_str(ISSUE_70129).unwrap(),
        serde_json::from_str(ISSUE_64663).unwrap(),
    ]))
}

fn main() {
    let f = query()
        .map_err(|err| eprintln!("error: {}", err))
        .for_each(|iss| {
            println!("issue #{}, {}", iss.number, iss.title);
            Ok(())
        });
    let mut rt = tokio::runtime::Runtime::new().unwrap();
    rt.block_on(f).unwrap();
}
